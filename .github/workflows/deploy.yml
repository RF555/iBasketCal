# GitHub Actions - CI Pipeline for iBasketCal
#
# Runs tests on push/PR to verify code quality.
# Deployment is handled by Render (auto-deploys on push to main).

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  # =========================================================================
  # Test Job
  # =========================================================================
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Run tests
        run: |
          # Import tests
          python -c "from src.storage import get_database, DatabaseInterface; print('✓ Storage module')"
          python -c "from src.storage.sqlite_db import SQLiteDatabase; print('✓ SQLiteDatabase module')"
          python -c "from src.services.data_service import DataService; print('✓ DataService module')"
          python -c "from src.services.calendar_service import CalendarService; print('✓ CalendarService module')"
          python -c "from src.main import app; print('✓ FastAPI app')"

          # Database CRUD test
          python -c "
          from src.storage.sqlite_db import SQLiteDatabase
          import tempfile
          import os

          with tempfile.TemporaryDirectory() as tmpdir:
              db = SQLiteDatabase(db_path=os.path.join(tmpdir, 'test.db'))
              db.initialize()
              db.save_seasons([{'_id': 'test', 'name': 'Test Season'}])
              seasons = db.get_seasons()
              assert len(seasons) == 1
              print('✓ Database CRUD works')
          "

          echo "All tests passed!"
